<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html xmlns:uiform>
   <head>
      <!---------------------------------------------------------->
      <!----------------- HOME DE LA APLICACION ------------------>
      <!---------------------------------------------------------->
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
      
       <!-- Latest compiled and minified CSS -->
      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
      <!-- jQuery library -->
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
      <!-- Latest compiled JavaScript -->
      <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
      <!-- Valildator -->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/1000hz-bootstrap-validator/0.11.9/validator.min.js"></script>

      <!-- D3 graphics -->
      <script src="https://d3js.org/d3.v4.min.js"></script>
      
      <script language="Javascript" src="/stock-alerts/pages/js/httpUtils.js"> </script>
      
      <script language="Javascript">
         
         function startup(){
           
         }

         function consult( event ){
             //avoids default submit process
             event.preventDefault();
        	    var tickerInput = document.getElementById( "tickerSymbol" );
        	    var historyCheckbox = document.getElementById( "historyCheckbox" );
             var url = "/stock-alerts/stocks" + (historyCheckbox.checked? "/history" :"") + "?symbol=" + tickerInput.value;
             httpGetAsync( url, function( result ){ 
                 document.getElementById( "resultDiv" ).innerHTML = result; 
                 if( historyCheckbox.checked ){
                	  initChart(JSON.parse(result)); 
                 }else{
                	  initChart(JSON.parse(result).stock.history); 
                 }
             } );
         }

         // parse the date / time
         var parseTime = d3.timeParse("%d/%m/%Y");

       //helper function
         function getDate(d) {
             if(typeof d.date == "string"){
            	   return parseTime( d.date );
             }else{
                 //Date has come in "long" format
            	 return new Date( d.date );
             }
         }

         function getMaxPrice( data ){
             var max = 0;
             for(var i = 0; i < data.length ; i++){
                var price = data[i].close;
                if(price > max){
                   max = price;
                }
             }

             return max * 1.5;
          }

         function initChart( data ) {
        	   document.getElementById("visualisation").innerHTML = "";
				// get max and min dates - this assumes data is sorted
				var maxDate = getDate(data[0]),
				    minDate = getDate(data[data.length-1]);


             var vis = d3.select("#visualisation"),
                 WIDTH = 1000,
                 HEIGHT = 500,
                 MARGINS = {
                     top: 20,
                     right: 20,
                     bottom: 20,
                     left: 50
                 },
                 xScale = d3.scaleTime().range([MARGINS.left, WIDTH - MARGINS.right]).domain([minDate, maxDate]),
                 yScale = d3.scaleLinear().range([HEIGHT - MARGINS.top, MARGINS.bottom]).domain([0, getMaxPrice(data)]),
                 xAxis = d3.axisBottom().scale(xScale),
                 yAxis = d3.axisLeft().scale(yScale);
             
             vis.append("svg:g")
                 .attr("class", "x axis")
                 .attr("transform", "translate(0," + (HEIGHT - MARGINS.bottom) + ")")
                 .call(xAxis);
             vis.append("svg:g")
                 .attr("class", "y axis")
                 .attr("transform", "translate(" + (MARGINS.left) + ",0)")
                 .call(yAxis);
             
             var lineGen = d3.line()
                 .x(function(d) {
                     console.log(d.date + " = " + getDate(d));
                     return xScale(getDate(d));
                 })
                 .y(function(d) {
                     return yScale(d.close);
                 })
                 .curve(d3.curveBasis)
             
             vis.append('svg:path')
                 .attr('d', lineGen(data))
                 .attr('stroke', 'green')
                 .attr('stroke-width', 2)
                 .attr('fill', 'none');
             
             /*vis.append('svg:path')
                 .attr('d', lineGen(data2))
                 .attr('stroke', 'blue')
                 .attr('stroke-width', 2)
                 .attr('fill', 'none');*/
         }

      </script>
   </head>
   
   <body onload="startup();" style="overflow: auto; margin: 0px; border: 0px;" >
   <div class="container">
      <h2>Stocks</h2>
	   <form data-toggle="validator" name="stocksForm" id="stocksForm" onsubmit="consult(event)">
		  <div class="form-group">
		    <label for="tickerSymbol">Ticker Symbol</label>
		    <input type="text" class="form-control" id="tickerSymbol" aria-describedby="symbolHelp" placeholder="TSLA" required data-minlength="1">
		    <small id="symbolHelp" class="form-text text-muted">Use Yahoo notation (".BA" for Buenos Aires stocks)</small>
		  </div>
		  <div class="checkbox">
	        <label><input id="historyCheckbox" type="checkbox"> Get history</label>
	     </div>
	     <div class="form-group">
		    <button type="submit" class="btn btn-primary">Consult</button>
		  </div>
		</form>
		<div id="resultDiv">
		</div>
		<svg id="visualisation" width="1000" height="500"></svg>
	</div>
	
   </body>
</html>